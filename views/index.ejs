<html>

<head>
  <title>Express</title>
  <link href="https://fonts.googleapis.com/css?family=Anton|Merriweather&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/stylesheets/style.css?ver=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
</head>

<body>
  <main id="app">
    <section class="screen" v-if="screenIndex === 0">
      <button class="top-right-button" 
        type=button 
        onclick="window.location.href='/info'">I</button>
      <section v-if="!todaysChallenge">
        <p>Det finns ingen aktuell utmaning.</p>
      </section>
      <section v-if="todaysChallenge">
        <section v-show="!todaysChallenge.done">
            <h1>
              Dagens challenge
            </h1>
            <p class="challenge-text" v-html="todaysChallenge.description"></p>
            <section class="fullscreen-container" v-if="todaysChallenge.fullscreen">
              <section v-show="!todaysChallenge.fullscreen.visible">
                <a href="#" @click.prevent="todaysChallenge.fullscreen.visible = true">{{ todaysChallenge.fullscreen.linkDescription }}</a>
              </section>
              <section class="fullscreen-element" v-if="todaysChallenge.fullscreen.visible">
                <button 
                  type=button
                  class="top-right-button"
                  @click="todaysChallenge.fullscreen.visible = false">X</button>
                <img class="fullscreen-image" v-if="todaysChallenge.fullscreen.imageSource" 
                  :src="todaysChallenge.fullscreen.imageSource">
              </section>
            </section>
            <button type="button" @click="imDone">
              Jag har gjort dagens challenge!
            </button>
          </section>
          <section v-show="todaysChallenge.done">
            <p>BRA JOBBAT!</p>
            <img class="challenge-done-image" 
              src="images/together-yellow.png">
          </section>
      </section>
      <section>
        <section class="history-element__outer-container"
            v-for="(challenge, index) in challenges" @click="showMissionData(index)" >
          <section class="history-element__inner-container"
              :class="{done:challenge.done, current:index === todaysChallengeIndex}">
            {{index+1}}
          </section>
        </section>
      </section>
    </section>
    <section class="mission-details" class="screen" v-if="screenIndex === 1">
        <h1>Challenge number {{missionDetailIndex+1}}</h1>
        <p><strong><u>Challenge description:</u></strong> <span v-html="challenges[missionDetailIndex].description"></span></p>
        <p><strong><u>Date:</u></strong> {{challenges[missionDetailIndex].date}}</p>
        <p><strong><u>Completion:</u></strong> {{challenges[missionDetailIndex].done}}</p>
        <button  
        type=button 
        @click="goToScreen(0)">Back to 30 Day Challenge</button>
    </section>
  </main>

  <!-- development version, includes helpful console warnings -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script>
  const saveKey = "30daychallenge1-test2";

  var app = new Vue({
    el: '#app',
    data: {
      fullUserData: {},
      screenIndex: 0,
      missionDetailIndex: 0,
      challenges: [
        { description: "Try the method <a href=\"https://en.wikipedia.org/wiki/Five_whys\">Five whys</a>.", date: new Date(2019, 10, 13), done: false },
        { description: "Find a bunch of people and try to solve something by using the method <a href\"/reverse-brainstorming\">Reverse Brainstorming.</a>", date: new Date(2019, 10, 9), done: false },
        { description: "Update your info at <a href=\"https://admin.chalmers.se/en/_layouts/chalmersPublicWeb/profilePage.aspx\">chalmers.se</a> so that the info is correct.", fullscreen: { imageSource:"images/30DC.gif", linkDescription:"Click here to see how.", visible:false }, date: new Date(2019, 10, 6), done: false },
        { description: "Try mindfulness. If you want, you can try one of <a href=\"https://www.mindful.org/audio-resources-for-mindfulness-meditation/\">these</a> audio guided meditations.", date: new Date(2019, 10, 5), done: false },
        { description: "Try some yoga exercises, together or alone. If you want, you can try some of <a href=\"https://www.verywellfit.com/essential-yoga-poses-for-beginners-3566747\">these</a> exercises.", date: new Date(2019, 10, 7), done: false }
      ]

      /*challenges: [
        { description: "Take a walk with at least one colleague.", date: new Date(2019, 10, 25), done: false },
        { description: "Try some yoga exercises, together or alone. If you want, you can try some of <a href=\"https://www.verywellfit.com/essential-yoga-poses-for-beginners-3566747\">these</a> exercises.", date: new Date(2019, 10, 26), done: false },
        { description: "Share your best tip for making your workday easier and why this works for you.", date: new Date(2019, 10, 27), done: false },
        { description: "Try one of your colleagues tip for making the workday easier.", date: new Date(2019, 10, 28), done: false },
        { description: "Make an attempt to solve <a href=\"\">this</a> puzzle.", date: new Date(2019, 10, 29), done: false },
        { description: "Go outside and find something small to study in detail. Look at the thing very closely and draw it.", date: new Date(2019, 11, 2), done: false },
        { description: "Ask a colleague you don't work with that much about what she or he is working with right now and also what she or he likes to do outside of work.", date: new Date(2019, 11, 3), done: false },
        { description: "Play <a href=\"https://bluelemon.itch.io/tiny-clusters\">this</a> game.", date: new Date(2019, 11, 4), done: false },
        { description: "Update your info at <a href=\"https://admin.chalmers.se/en/_layouts/chalmersPublicWeb/profilePage.aspx\">chalmers.se</a> so that the info is correct.", date: new Date(2019, 11, 5), done: false },
        { description: "Fold paper airplanes.", date: new Date(2019, 11, 6), done: false },
        { description: "Do something kind for another colleague, perhaps in secret.", date: new Date(2019, 11, 9), done: false },
        { description: "Find a bunch of people and try to solve something by using the method <a href\"/reverse-brainstorming\">Reverse Brainstorming.</a>", date: new Date(2019, 11, 10), done: false },
        { description: "Show someone something that you have done and ask what she or he thinks of it.", date: new Date(2019, 11, 11), done: false },
        { description: "Write freely for 15 minutes about what you have done today, what you possibly have learned and how this, in that case, can be of help for you in the future.", date: new Date(2019, 11, 12), done: false },
        { description: "Do something you don't normally do.", date: new Date(2019, 11, 13), done: false },
        { description: "Try mindfulness. If you want, you can try one of <a href=\"https://www.mindful.org/audio-resources-for-mindfulness-meditation/\">these</a> audio guided meditations.", date: new Date(2019, 11, 16), done: false },
        { description: "Identify the user of something that you are currently working with. Take the role of the user for 15 minutes.", date: new Date(2019, 11, 17), done: false },
        { description: "Try the method <a href=\"https://en.wikipedia.org/wiki/Five_whys\">Five whys</a>.", date: new Date(2019, 11, 18), done: false },
        { description: "Switch office/workplace with a colleague for one hour.", date: new Date(2019, 11, 19), done: false },
        { description: "Take a morning \"fika\" in the lunch room.", date: new Date(2019, 11, 20), done: false }
      ]*/
    },
    mounted: function() {
      this.loadUserData();
    },
    computed: {
      todaysChallengeIndex: function() {
        let result = -1;
        let todaysDate = new Date();
        for (var i=0; i<this.challenges.length; i++) {
          let date = this.challenges[i].date;
          if (todaysDate.getFullYear() === date.getFullYear() &&
              todaysDate.getMonth() === date.getMonth() &&
              todaysDate.getDate() === date.getDate() &&
              todaysDate.getHours() >= 7 &&
              todaysDate.getHours() < 18) {
            result = i;
          }
        }
        return result;
      },
      todaysChallenge: function() {
        let result;
        let index = this.todaysChallengeIndex;
        if (index >= 0) {
          result = this.challenges[index];
        }
        return result;
      }
    },
    methods: {
      imDone: function () {
        this.todaysChallenge.done = true;
        this.saveUserData();
      },
      loadUserData: function() {
        let xhr = new XMLHttpRequest();
        xhr.open("GET", "/api");
        xhr.onload = function() {
          if (xhr.status !== 200) {
            // TODO: SHOW ERROR
          } else {
            try {
              this.fullUserData = JSON.parse(xhr.response);
              let userData = this.fullUserData[saveKey];
              if (userData) {
                if (typeof userData.screenIndex !== "undefined") {
                  this.screenIndex = userData.screenIndex;
                }
                for (var i=0; i<userData.doneChallenges.length; i++) {
                  let doneChallengeIndex = userData.doneChallenges[i];
                  this.challenges[doneChallengeIndex].done = true;
                }
              }
            } catch (error) {
              // TODO: SHOW ERROR
            }
          }
        }.bind(this);
        xhr.onerror = function() {
          // TODO: SHOW ERROR
        }
        xhr.send();
      },
      saveUserData: function() {
        let userData = {
          screenIndex: this.screenIndex,
          doneChallenges: []
        };

        for (var i=0; i<this.challenges.length; i++) {
          let challenge = this.challenges[i];
          if (challenge.done) {
            userData.doneChallenges.push(i);
          }
        }

        this.fullUserData[saveKey] = userData;

        let xhr = new XMLHttpRequest();
        xhr.open("POST", "/api");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onload = function() {
          if (xhr.status !== 200) {
            // TODO: SHOW ERROR
          }
        }
        xhr.onerror = function() {
          // TODO: SHOW ERROR
        }
        xhr.send(JSON.stringify(this.fullUserData));
      },
      goToScreen: function(index) {
        this.screenIndex = index;
      },
      showMissionData: function(missionIndex){
        this.missionDetailIndex = missionIndex;
        this.goToScreen(1);
      //},
        //showDate: function(date){
          //return toDateString(date);
      }//,
        //showIfMissionDone: function(missionsIndex){
          //if (challenges[missionIndex].done){
            //return 0;
          //}
          //else {
            //return 1;
          //} 
      //}
    },
    watch: {
      screenIndex: function() { this.saveUserData() }
    }
  })
  </script>
</body>

</html>
